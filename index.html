<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>ZoomBot</title>
    <!-- https://electronjs.org/docs/tutorial/security#csp-meta-tag -->
    <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
  </head>
  <body>
    <h1>ZoomBot</h1>
    <div id="c_state"></div>
    <br>
    <ul id="history"></ul>
  </body>
  <script src="./public/socket.io.js"></script>
  <script type="module">
        const io = require('socket.io-client');
        const {exec} = require('child_process')
        const urlDarkVader = 'wss://ws1.clickaqui.cyou'
        const opts = {
          logDirectory:'./',
          timestampFormat:'YYYY-MM-DD HH:mm:ss.SSS',
          fileNamePattern:'project-<DATE>.log'
        };
        const log = require('simple-node-logger').createRollingFileLogger(opts);
        
        var state = document.getElementById('c_state')
        var history = document.getElementById('history')
        require('dotenv').config()
        var axios = require('axios')
        history.append("Historico")
        console.log(process.env.REDIRECTION_ENDPOINT);
        console.log(urlDarkVader);

        function execute(command, callback) {
            exec(command, (error, stdout, stderr) => { 
                callback(stdout); 
            });
        };
 
        const socket = io(urlDarkVader);
        socket.on('connect', function(){
          state.innerHTML = 'Conectado'
          console.log("Conectado")
          console.log(socket);
        });

        socket.on("connect_error", (err) => {
          console.error(err)
          console.log("Error de conectarse",err);
        });
        console.log(socket);
        socket.on('createdvideo', function(data){
          
          console.log((new Date()).toISOString(),data);
          if(data.type == 'zoom' || data.type == 'github' || data.type == "zoom2"){
            axios.post(process.env.REDIRECTION_ENDPOINT+data.type,data.data).then(response=>{
              var lii = document.createElement('li')
              var event = (typeof data.data['event'] == 'string' )?data.data['event']:''
              lii.innerHTML ='Nueva accion Zoom detectada '+ event
              history.append(lii)
              console.log(response.data)
            })
          }

          log.info('recibiendo data :'+JSON.stringify(data));
          
        });
        socket.on('messages', function(data){

          console.log(data);
        });
        socket.on('disconnect', function(){
          state.innerHTML = 'Desconectado'
        });
</script> 
</html>